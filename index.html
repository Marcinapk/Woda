<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator zapotrzebowania na wodę</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    .header { padding: 16px; background: #111; color: #fff; }
    .header h1 { margin: 0 0 6px; font-size: 18px; }
    .header p { margin: 0; opacity: .85; font-size: 13px; }

    .container { padding: 12px; display: grid; gap: 12px; max-width: 1100px; margin: 0 auto; }
    .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .card h2 { margin: 0 0 10px; font-size: 16px; }

    .grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { display: grid; gap: 6px; font-size: 13px; }
    input, select { padding: 10px; border: 1px solid #d8dbe6; border-radius: 10px; font-size: 16px; }

    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .btn { padding: 10px 12px; border: 1px solid #d8dbe6; background: #fff; border-radius: 10px; font-size: 14px; cursor: pointer; }
    .btn.primary { background: #111; border-color: #111; color: #fff; }
    .btn.danger { background: #fff; border-color: #d33; color: #d33; }

    .tableWrap { overflow: auto; border: 1px solid #eef0f6; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 720px; }
    th, td { padding: 10px; border-bottom: 1px solid #eef0f6; font-size: 13px; }
    th { text-align: left; background: #fafbff; }
    td input, td select { width: 100%; box-sizing: border-box; font-size: 14px; padding: 8px; }

    .summary { margin-top: 10px; font-size: 13px; }
    .hint { margin-top: 10px; font-size: 12px; opacity: .8; }

    .results { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin-top: 10px; }
    .result { border: 1px solid #eef0f6; border-radius: 10px; padding: 10px; }
    .result .k { font-size: 12px; opacity: .75; }
    .result .v { font-size: 16px; margin-top: 4px; }

    .status { border-radius: 12px; padding: 12px; border: 1px solid #eef0f6; }
    .statusTitle { font-weight: 700; margin-bottom: 6px; }
    .status.neutral { background: #fafbff; }
    .status.ok { background: #f1fff4; border-color: #b7f0c3; }
    .status.bad { background: #fff2f2; border-color: #f0b7b7; }

    .status.warn { background: #fffbe6; border-color: #ffe08a; }
    .warnBox { border-radius: 12px; padding: 10px; border: 1px solid #ffe08a; background: #fffbe6; font-size: 12px; }
    .subcard { margin-top: 10px; border: 1px solid #eef0f6; border-radius: 12px; padding: 10px; }
    .subhead { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom: 8px;}
    .subhead h3 { margin:0; font-size: 14px; }
    .small { font-size: 12px; opacity: .85; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Kalkulator zapotrzebowania na wodę</h1>
    <p>Wpisz dane → Oblicz → wynik + zapas + OK / BRAK WODY</p>
  </header>

  <main class="container">

    <section class="card">
      <h2>Parametry pożaru</h2>
      <div class="grid">
        <label>
          Powierzchnia pożaru A [m²]
          <input id="A" type="number" inputmode="decimal" min="0" step="0.01" value="800">
        </label>

        <label>
          Gęstość obciążenia ogniowego q<sub>d</sub> [MJ/m²]
          <input id="qd" type="number" inputmode="decimal" min="0" step="1" value="500">
        </label>

        <label>
          Intensywność I [l/s·m²]
          <input id="I" type="number" inputmode="decimal" min="0" step="0.01" value="0.2">
        </label>
      </div>

      <div class="hint">
        Czas t [h] dobierany jest z tabeli progów (jak w Excelu).
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h2>Wozy pożarnicze (edytowalne)</h2>
        <button id="addVehicle" class="btn">Dodaj pojazd</button>
      </div>

      <div class="tableWrap">
        <table id="vehiclesTable">
          <thead>
            <tr>
              <th>Nazwa pojazdu</th>
              <th>Pojemność zbiornika [l]</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="summary">
        Suma wody w pojazdach: <strong><span id="sumWater">0</span> l</strong>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h2>Prądy gaśnicze (edytowalne)</h2>
        <button id="addStream" class="btn">Dodaj prąd</button>
      </div>

      <div class="tableWrap">
        <table id="streamsTable">
          <thead>
            <tr>
              <th>Opis</th>
              <th>Wydatek 1 prądu [l/min]</th>
              <th>Liczba prądów</th>
              <th>Łączny wydatek [l/min]</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="summary">
        Całkowity wydatek dostępny: <strong><span id="qAvail">0</span> l/min</strong>
      </div>
    </section>

    <!-- NOWE: ŹRÓDŁA ZEWNĘTRZNE -->
    <section class="card">
      <h2>Źródła zewnętrzne (zapas wody)</h2>

      <div class="warnBox">
        Hydranty i cieki wodne liczymy jako <strong>dodatkową pulę litrów</strong> (wariant 1), czyli wpływają na czas pracy (V), a nie zmieniają warunku przepływu.
        Dla hydrantów domyślnie przyjmujemy limit <strong>2 h</strong> działania sieci na cele ppoż.
      </div>

      <div class="subcard">
        <div class="subhead">
          <h3>Hydranty zewnętrzne (2 h)</h3>
          <button id="addHydrant" class="btn">Dodaj hydrant</button>
        </div>

        <div class="tableWrap">
          <table id="hydrantsTable">
            <thead>
              <tr>
                <th>Typ</th>
                <th>Liczba</th>
                <th>Wydajność 1 szt. [l/s]</th>
                <th>Woda w 2 h [l]</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="summary">
          Woda z hydrantów (2 h): <strong><span id="sumHydrants">0</span> l</strong>
          <div class="small" style="margin-top:6px;">
            Ostrzeżenie: po 2 h zasób liczony w kalkulatorze może się skończyć (sieć może działać dłużej, ale przyjmujemy 2 h).
          </div>
        </div>
      </div>

      <div class="subcard">
        <div class="subhead">
          <h3>Zbiorniki (wymiary lub litry)</h3>
          <button id="addTank" class="btn">Dodaj zbiornik</button>
        </div>

        <div class="tableWrap">
          <table id="tanksTable">
            <thead>
              <tr>
                <th>Opis</th>
                <th>Tryb</th>
                <th>Wymiary L×W×H [m] lub Litry [l]</th>
                <th>Obliczona pojemność [l]</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="summary">
          Woda ze zbiorników: <strong><span id="sumTanks">0</span> l</strong>
        </div>
      </div>

      <div class="subcard">
        <div class="subhead">
          <h3>Cieki wodne (Q i czas wykorzystania)</h3>
          <button id="addRiver" class="btn">Dodaj ciek</button>
        </div>

        <!-- IMGW picker -->
        <div class="grid" style="margin-top:8px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
          <label>
            Województwo
            <select id="imgwWoj"></select>
          </label>
          <label>
            Powiat
            <select id="imgwPow"></select>
          </label>
          <label>
            Rzeka
            <select id="imgwRzeka"></select>
          </label>
          <label>
            Stacja
            <select id="imgwStacja"></select>
          </label>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="small">
            Po wyborze stacji kliknij „Dodaj stację do cieków” – Q [m³/s] wypełni się automatycznie.
          </div>
          <button id="imgwAddToRivers" class="btn">Dodaj stację do cieków</button>
        </div>

        <div class="tableWrap" style="margin-top:8px;">
          <table id="riversTable">
            <thead>
              <tr>
                <th>Opis</th>
                <th>Q [m³/s]</th>
                <th>Q [l/s]</th>
                <th>Czas [h]</th>
                <th>Woda [l]</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="summary">
          Woda z cieków (wg przyjętych Q i czasu): <strong><span id="sumRivers">0</span> l</strong>
          <div class="small" style="margin-top:6px;">
            Ostrzeżenie: przepływy w ciekach są zmienne; przyjmujesz wartość orientacyjną i czas wykorzystania (domyślnie 2 h).
          </div>
        </div>
      </div>

      <div class="summary" style="margin-top:12px;">
        Zapas zewnętrzny łącznie: <strong><span id="sumExternal">0</span> l</strong><br/>
        Suma wody łącznie (wozy + zewn.): <strong><span id="sumTotal">0</span> l</strong>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <button id="calc" class="btn primary">Oblicz</button>
        <button id="save" class="btn">Zapisz ustawienia</button>
        <button id="reset" class="btn danger">Reset</button>
      </div>
    </section>

    <section class="card">
      <h2>Wynik</h2>

      <div id="statusBox" class="status neutral">
        <div class="statusTitle">—</div>
        <div class="statusDesc">Wprowadź dane i kliknij „Oblicz”.</div>
      </div>

      <div class="results">
        <div class="result">
          <div class="k">Czas pożaru t</div>
          <div class="v"><span id="tHours">—</span> h</div>
        </div>
        <div class="result">
          <div class="k">Wymagany przepływ Q<sub>req</sub></div>
          <div class="v"><span id="qReq">—</span> l/min</div>
        </div>
        <div class="result">
          <div class="k">Wymagana ilość wody V</div>
          <div class="v"><span id="vLiters">—</span> l</div>
        </div>
        <div class="result">
          <div class="k">Rzeczywista intensywność I<sub>real</sub></div>
          <div class="v"><span id="iReal">—</span> l/s·m²</div>
        </div>
        <div class="result">
          <div class="k">Zapas intensywności</div>
          <div class="v"><span id="reserveI">—</span>%</div>
        </div>
        <div class="result">
          <div class="k">Czas pracy z wody łącznej</div>
          <div class="v"><span id="tAvail">—</span> min</div>
        </div>
        <div class="result">
          <div class="k">Zapas czasowy</div>
          <div class="v"><span id="reserveT">—</span>%</div>
        </div>
      </div>

      <div class="hint">
        „OK” oznacza jednocześnie spełnienie: Q<sub>avail</sub> ≥ Q<sub>req</sub> oraz czas z wody łącznej ≥ czas wymagany.
        (Wariant 1: źródła zewnętrzne zwiększają tylko pulę litrów.)
      </div>
    </section>
  </main>

  <script>
    // Tabela qd -> t [h] (jak w Excelu)
    // LOOKUP: bierze największy próg <= qd
    const qdTable = [
      { qd: 200,  t: 0.3 },
      { qd: 1800, t: 2.0 },
      { qd: 2600, t: 3.0 },
      { qd: 3400, t: 4.0 },
      { qd: 3900, t: 5.0 },
      { qd: 4500, t: 6.0 },
      { qd: 5100, t: 7.0 },
      { qd: 5900, t: 8.0 },
    ];

    // --- IMGW: stacje i przepływy (ręcznie wprowadzone) ---
    const IMGW_STATIONS = [
      {
        woj: "podkarpackie",
        powiat: "krośnieński",
        rzeka: "Wisłok",
        stacja: "Krosno",
        q_m3s: 1.8,
        data: "2024-11-01"
      },
      {
        woj: "podkarpackie",
        powiat: "przemyski",
        rzeka: "San",
        stacja: "Przemyśl",
        q_m3s: 12.4,
        data: "2024-11-01"
      }
    ];

    const els = {
      A: document.getElementById("A"),
      qd: document.getElementById("qd"),
      I: document.getElementById("I"),
      vehiclesTbody: document.querySelector("#vehiclesTable tbody"),
      streamsTbody: document.querySelector("#streamsTable tbody"),
      sumWater: document.getElementById("sumWater"),
      qAvail: document.getElementById("qAvail"),
      calc: document.getElementById("calc"),
      addVehicle: document.getElementById("addVehicle"),
      addStream: document.getElementById("addStream"),
      save: document.getElementById("save"),
      reset: document.getElementById("reset"),

      statusBox: document.getElementById("statusBox"),
      tHours: document.getElementById("tHours"),
      qReq: document.getElementById("qReq"),
      vLiters: document.getElementById("vLiters"),
      iReal: document.getElementById("iReal"),
      reserveI: document.getElementById("reserveI"),
      tAvail: document.getElementById("tAvail"),
      reserveT: document.getElementById("reserveT"),

      // external
      hydrantsTbody: document.querySelector("#hydrantsTable tbody"),
      tanksTbody: document.querySelector("#tanksTable tbody"),
      riversTbody: document.querySelector("#riversTable tbody"),
      addHydrant: document.getElementById("addHydrant"),
      addTank: document.getElementById("addTank"),
      addRiver: document.getElementById("addRiver"),
      sumHydrants: document.getElementById("sumHydrants"),
      sumTanks: document.getElementById("sumTanks"),
      sumRivers: document.getElementById("sumRivers"),
      sumExternal: document.getElementById("sumExternal"),
      sumTotal: document.getElementById("sumTotal"),

      // IMGW picker
      imgwWoj: document.getElementById("imgwWoj"),
      imgwPow: document.getElementById("imgwPow"),
      imgwRzeka: document.getElementById("imgwRzeka"),
      imgwStacja: document.getElementById("imgwStacja"),
      imgwAddToRivers: document.getElementById("imgwAddToRivers"),
    };

    function n(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }
    function round(x, d = 2) {
      const p = Math.pow(10, d);
      return Math.round(x * p) / p;
    }
    function lookupFireTimeHours(qd) {
      const q = n(qd);
      let t = 0;
      for (const row of qdTable) {
        if (q >= row.qd) t = row.t;
      }
      return t; // h
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // --- vehicles ---
    function vehicleRow(name = "", liters = 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="v-name" type="text" value="${escapeHtml(name)}" placeholder="np. GBA 3,5/29"></td>
        <td><input class="v-liters" type="number" inputmode="decimal" min="0" step="1" value="${n(liters)}"></td>
        <td><button class="btn danger v-del">Usuń</button></td>
      `;
      tr.querySelector(".v-del").addEventListener("click", () => { tr.remove(); recalcLive(); });
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalcLive));
      return tr;
    }

    function getVehicles() {
      const rows = [...els.vehiclesTbody.querySelectorAll("tr")];
      return rows.map(tr => ({
        name: tr.querySelector(".v-name").value.trim(),
        liters: n(tr.querySelector(".v-liters").value),
      }));
    }

    // --- streams ---
    function streamRow(desc = "", one = 0, count = 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="s-desc" type="text" value="${escapeHtml(desc)}" placeholder="np. Linia W-52..."></td>
        <td><input class="s-one" type="number" inputmode="decimal" min="0" step="1" value="${n(one)}"></td>
        <td><input class="s-count" type="number" inputmode="decimal" min="0" step="1" value="${n(count)}"></td>
        <td class="s-total">0</td>
        <td><button class="btn danger s-del">Usuń</button></td>
      `;
      tr.querySelector(".s-del").addEventListener("click", () => { tr.remove(); recalcLive(); });
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalcLive));
      return tr;
    }

    function getStreams() {
      const rows = [...els.streamsTbody.querySelectorAll("tr")];
      return rows.map(tr => ({
        desc: tr.querySelector(".s-desc").value.trim(),
        one: n(tr.querySelector(".s-one").value),
        count: n(tr.querySelector(".s-count").value),
      }));
    }

    // --- hydrants ---
    const HYDRANT_TYPES = {
      "DN80": 10,  // dm3/s = l/s
      "DN100": 15  // dm3/s = l/s
    };
    const HYDRANT_HOURS = 2; // stałe 2h (wariant 1)
    function hydrantRow(type = "DN80", count = 1) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <select class="h-type">
            <option value="DN80"${type==="DN80"?" selected":""}>DN80</option>
            <option value="DN100"${type==="DN100"?" selected":""}>DN100</option>
          </select>
        </td>
        <td><input class="h-count" type="number" inputmode="decimal" min="0" step="1" value="${n(count)}"></td>
        <td class="h-one">0</td>
        <td class="h-liters">0</td>
        <td><button class="btn danger h-del">Usuń</button></td>
      `;
      tr.querySelector(".h-del").addEventListener("click", () => { tr.remove(); recalcLive(); });
      tr.querySelectorAll("input,select").forEach(inp => inp.addEventListener("input", recalcLive));
      return tr;
    }
    function getHydrants() {
      const rows = [...els.hydrantsTbody.querySelectorAll("tr")];
      return rows.map(tr => ({
        type: tr.querySelector(".h-type").value,
        count: n(tr.querySelector(".h-count").value),
      }));
    }

    // --- tanks ---
    function tankRow(desc = "", mode = "dims", L = 0, W = 0, H = 0, liters = 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="t-desc" type="text" value="${escapeHtml(desc)}" placeholder="np. Zbiornik ppoż / staw"></td>
        <td>
          <select class="t-mode">
            <option value="dims"${mode==="dims"?" selected":""}>Wymiary (m)</option>
            <option value="liters"${mode==="liters"?" selected":""}>Litry</option>
          </select>
        </td>
        <td class="t-inputs"></td>
        <td class="t-out">0</td>
        <td><button class="btn danger t-del">Usuń</button></td>
      `;
      const inputsCell = tr.querySelector(".t-inputs");

      function renderInputs() {
        const m = tr.querySelector(".t-mode").value;
        if (m === "dims") {
          inputsCell.innerHTML = `
            <div style="display:grid; grid-template-columns: repeat(3, minmax(90px,1fr)); gap:6px;">
              <input class="t-L" type="number" inputmode="decimal" min="0" step="0.01" value="${n(L)}" placeholder="L">
              <input class="t-W" type="number" inputmode="decimal" min="0" step="0.01" value="${n(W)}" placeholder="W">
              <input class="t-H" type="number" inputmode="decimal" min="0" step="0.01" value="${n(H)}" placeholder="H">
            </div>
          `;
        } else {
          inputsCell.innerHTML = `
            <input class="t-lit" type="number" inputmode="decimal" min="0" step="1" value="${n(liters)}" placeholder="Pojemność [l]">
          `;
        }
        inputsCell.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalcLive));
      }

      tr.querySelector(".t-mode").addEventListener("input", () => { renderInputs(); recalcLive(); });
      tr.querySelector(".t-del").addEventListener("click", () => { tr.remove(); recalcLive(); });
      tr.querySelector(".t-desc").addEventListener("input", recalcLive);

      renderInputs();
      return tr;
    }
    function getTanks() {
      const rows = [...els.tanksTbody.querySelectorAll("tr")];
      return rows.map(tr => {
        const mode = tr.querySelector(".t-mode").value;
        const desc = tr.querySelector(".t-desc").value.trim();
        if (mode === "dims") {
          return {
            desc, mode,
            L: n(tr.querySelector(".t-L")?.value),
            W: n(tr.querySelector(".t-W")?.value),
            H: n(tr.querySelector(".t-H")?.value),
            liters: 0
          };
        } else {
          return {
            desc, mode,
            L: 0, W: 0, H: 0,
            liters: n(tr.querySelector(".t-lit")?.value)
          };
        }
      });
    }

    // --- rivers ---
    function riverRow(desc = "", q_m3s = 0, q_ls = 0, hours = 2) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="r-desc" type="text" value="${escapeHtml(desc)}" placeholder="np. Wisłok – most"></td>
        <td><input class="r-qm3s" type="number" inputmode="decimal" min="0" step="0.001" value="${n(q_m3s)}"></td>
        <td><input class="r-qls" type="number" inputmode="decimal" min="0" step="0.1" value="${n(q_ls)}"></td>
        <td><input class="r-h" type="number" inputmode="decimal" min="0" step="0.1" value="${n(hours)}"></td>
        <td class="r-out">0</td>
        <td><button class="btn danger r-del">Usuń</button></td>
      `;
      tr.querySelector(".r-del").addEventListener("click", () => { tr.remove(); recalcLive(); });
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalcLive));
      return tr;
    }
    function getRivers() {
      const rows = [...els.riversTbody.querySelectorAll("tr")];
      return rows.map(tr => ({
        desc: tr.querySelector(".r-desc").value.trim(),
        q_m3s: n(tr.querySelector(".r-qm3s").value),
        q_ls: n(tr.querySelector(".r-qls").value),
        hours: n(tr.querySelector(".r-h").value),
      }));
    }

    function setStatus(type, title, desc) {
      els.statusBox.className = `status ${type}`;
      els.statusBox.querySelector(".statusTitle").textContent = title;
      els.statusBox.querySelector(".statusDesc").textContent = desc;
    }

    function calcSums() {
      // vehicles liters
      const vehicles = getVehicles();
      const sumWaterVehicles = vehicles.reduce((a, v) => a + n(v.liters), 0);

      // streams flow l/min
      const streams = getStreams();
      let qAvail = 0;
      const trs = [...els.streamsTbody.querySelectorAll("tr")];
      streams.forEach((s, i) => {
        const total = n(s.one) * n(s.count);
        qAvail += total;
        const cell = trs[i]?.querySelector(".s-total");
        if (cell) cell.textContent = String(round(total, 0));
      });

      // hydrants -> liters over 2h
      const hydrants = getHydrants();
      const hTrs = [...els.hydrantsTbody.querySelectorAll("tr")];
      let sumHydrants = 0;
      hydrants.forEach((h, i) => {
        const one_ls = HYDRANT_TYPES[h.type] ?? 0;
        const liters = one_ls * n(h.count) * HYDRANT_HOURS * 3600;
        sumHydrants += liters;
        const tr = hTrs[i];
        if (tr) {
          tr.querySelector(".h-one").textContent = String(round(one_ls, 1));
          tr.querySelector(".h-liters").textContent = String(round(liters, 0));
        }
      });

      // tanks -> liters
      const tanks = getTanks();
      const tTrs = [...els.tanksTbody.querySelectorAll("tr")];
      let sumTanks = 0;
      tanks.forEach((t, i) => {
        let liters = 0;
        if (t.mode === "dims") {
          // m3 -> liters
          liters = n(t.L) * n(t.W) * n(t.H) * 1000;
        } else {
          liters = n(t.liters);
        }
        sumTanks += liters;
        const tr = tTrs[i];
        if (tr) tr.querySelector(".t-out").textContent = String(round(liters, 0));
      });

      // rivers -> liters = Q * time
      const rivers = getRivers();
      const rTrs = [...els.riversTbody.querySelectorAll("tr")];
      let sumRivers = 0;
      rivers.forEach((r, i) => {
        // prefer q_ls if provided, else convert m3/s
        const q_ls = (n(r.q_ls) > 0) ? n(r.q_ls) : (n(r.q_m3s) * 1000);
        const liters = q_ls * n(r.hours) * 3600;
        sumRivers += liters;
        const tr = rTrs[i];
        if (tr) tr.querySelector(".r-out").textContent = String(round(liters, 0));
      });

      const sumExternal = sumHydrants + sumTanks + sumRivers;
      const sumTotal = sumWaterVehicles + sumExternal;

      // UI
      els.sumWater.textContent = String(round(sumWaterVehicles, 0));
      els.qAvail.textContent = String(round(qAvail, 0));
      els.sumHydrants.textContent = String(round(sumHydrants, 0));
      els.sumTanks.textContent = String(round(sumTanks, 0));
      els.sumRivers.textContent = String(round(sumRivers, 0));
      els.sumExternal.textContent = String(round(sumExternal, 0));
      els.sumTotal.textContent = String(round(sumTotal, 0));

      return { sumWaterVehicles, qAvail, sumExternal, sumTotal };
    }

    function compute() {
      const A = n(els.A.value);
      const qd = n(els.qd.value);
      const I = n(els.I.value);

      const tHours = lookupFireTimeHours(qd);                 // [h]
      const qReq_ls = A * I;                                  // [l/s]
      const qReq_lmin = qReq_ls * 60;                         // [l/min]
      const vLiters = qReq_ls * tHours * 3600;                // [l]

      const { sumTotal, qAvail } = calcSums();                // sumTotal [l], qAvail [l/min]
      const iReal = (A > 0) ? ((qAvail / 60) / A) : 0;        // [l/s·m²]

      const tAvailMin = (qAvail > 0) ? (sumTotal / qAvail) : 0; // [min]
      const tReqMin = tHours * 60;

      // Zapas intensywności: (I_real / I - 1) * 100
      const reserveI = (I > 0) ? ((iReal / I - 1) * 100) : 0;

      // Zapas czasowy: (tAvail / tReq - 1) * 100
      const reserveT = (tReqMin > 0) ? ((tAvailMin / tReqMin - 1) * 100) : 0;

      // Warunki OK:
      const okFlow = (qAvail >= qReq_lmin) && qReq_lmin > 0;
      const okTime = (tAvailMin >= tReqMin) && tReqMin > 0;

      // Wyniki
      els.tHours.textContent = String(round(tHours, 2));
      els.qReq.textContent = String(round(qReq_lmin, 0));
      els.vLiters.textContent = String(round(vLiters, 0));
      els.iReal.textContent = String(round(iReal, 3));
      els.reserveI.textContent = String(round(reserveI, 1));
      els.tAvail.textContent = String(round(tAvailMin, 1));
      els.reserveT.textContent = String(round(reserveT, 1));

      // Status
      if (A <= 0 || I <= 0 || qd <= 0) {
        setStatus("bad", "BRAK DANYCH", "Uzupełnij A, qd oraz I (wartości > 0).");
        return;
      }
      if (!okFlow && !okTime) {
        setStatus("bad", "BRAK WODY", "Brak wymaganej wydajności (l/min) oraz brak wymaganej ilości wody (czas pracy).");
        return;
      }
      if (!okFlow) {
        setStatus("bad", "BRAK WODY", "Brak wymaganej wydajności (Q_avail < Q_req).");
        return;
      }
      if (!okTime) {
        setStatus("bad", "BRAK WODY", "Wydajność jest OK, ale brak wymaganej ilości wody (czas pracy z wody łącznej za krótki).");
        return;
      }
      setStatus("ok", "OK", "Wydajność i ilość wody spełniają wymagania (zapas pokazany w %).");
    }

    function recalcLive() {
      calcSums();
    }

    // --- IMGW picker logic (4 dropdowns + add to rivers) ---
    function uniq(arr) {
      return [...new Set(arr)];
    }
    function setOptions(selectEl, values, selectedValue = "") {
      const opts = values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      selectEl.innerHTML = opts;
      if (selectedValue && values.includes(selectedValue)) {
        selectEl.value = selectedValue;
      } else if (values.length) {
        selectEl.value = values[0];
      }
    }

    function stationsFiltered() {
      const woj = els.imgwWoj.value;
      const pow = els.imgwPow.value;
      const rzeka = els.imgwRzeka.value;
      const st = els.imgwStacja.value;

      return IMGW_STATIONS.filter(x =>
        (!woj || x.woj === woj) &&
        (!pow || x.powiat === pow) &&
        (!rzeka || x.rzeka === rzeka) &&
        (!st || x.stacja === st)
      );
    }

    function refreshIMGWDropdowns(chain = "woj") {
      // chain indicates which changed; refresh downstream
      const wojList = uniq(IMGW_STATIONS.map(x => x.woj)).sort((a,b)=>a.localeCompare(b,"pl"));
      if (!els.imgwWoj.options.length) setOptions(els.imgwWoj, wojList);

      const curWoj = els.imgwWoj.value;
      const powList = uniq(IMGW_STATIONS.filter(x => x.woj === curWoj).map(x => x.powiat)).sort((a,b)=>a.localeCompare(b,"pl"));
      if (chain === "woj") setOptions(els.imgwPow, powList);
      const curPow = els.imgwPow.value;

      const rzekaList = uniq(IMGW_STATIONS.filter(x => x.woj === curWoj && x.powiat === curPow).map(x => x.rzeka)).sort((a,b)=>a.localeCompare(b,"pl"));
      if (chain === "woj" || chain === "pow") setOptions(els.imgwRzeka, rzekaList);
      const curRzeka = els.imgwRzeka.value;

      const stacjaList = uniq(IMGW_STATIONS.filter(x => x.woj === curWoj && x.powiat === curPow && x.rzeka === curRzeka).map(x => x.stacja)).sort((a,b)=>a.localeCompare(b,"pl"));
      if (chain === "woj" || chain === "pow" || chain === "rzeka") setOptions(els.imgwStacja, stacjaList);
    }

    function getSelectedStation() {
      const woj = els.imgwWoj.value;
      const pow = els.imgwPow.value;
      const rzeka = els.imgwRzeka.value;
      const st = els.imgwStacja.value;
      return IMGW_STATIONS.find(x => x.woj === woj && x.powiat === pow && x.rzeka === rzeka && x.stacja === st) || null;
    }

    function addSelectedStationToRivers() {
      const s = getSelectedStation();
      if (!s) {
        setStatus("bad", "BRAK STACJI", "Nie znaleziono stacji dla wybranych filtrów.");
        return;
      }
      const desc = `${s.rzeka} – ${s.stacja} (${s.powiat}, ${s.woj}) | IMGW ${s.data}`;
      els.riversTbody.appendChild(riverRow(desc, n(s.q_m3s), 0, 2));
      recalcLive();
      setStatus("neutral", "DODANO STACJĘ", `Dodano: ${s.rzeka} / ${s.stacja} (Q=${s.q_m3s} m³/s, ${s.data}).`);
    }

    function saveState() {
      const state = {
        A: els.A.value,
        qd: els.qd.value,
        I: els.I.value,
        vehicles: getVehicles(),
        streams: getStreams(),
        hydrants: getHydrants(),
        tanks: getTanks(),
        rivers: getRivers(),
        imgw: {
          woj: els.imgwWoj.value,
          pow: els.imgwPow.value,
          rzeka: els.imgwRzeka.value,
          stacja: els.imgwStacja.value
        }
      };
      localStorage.setItem("kalkulator_wody_state_v4", JSON.stringify(state));
      setStatus("neutral", "ZAPISANO", "Ustawienia zapisane lokalnie w urządzeniu.");
    }

    function loadState() {
      const raw = localStorage.getItem("kalkulator_wody_state_v4");
      if (!raw) return false;
      try {
        const s = JSON.parse(raw);
        els.A.value = s.A ?? els.A.value;
        els.qd.value = s.qd ?? els.qd.value;
        els.I.value = s.I ?? els.I.value;

        els.vehiclesTbody.innerHTML = "";
        (s.vehicles ?? []).forEach(v => els.vehiclesTbody.appendChild(vehicleRow(v.name, v.liters)));

        els.streamsTbody.innerHTML = "";
        (s.streams ?? []).forEach(st => els.streamsTbody.appendChild(streamRow(st.desc, st.one, st.count)));

        els.hydrantsTbody.innerHTML = "";
        (s.hydrants ?? []).forEach(h => els.hydrantsTbody.appendChild(hydrantRow(h.type, h.count)));

        els.tanksTbody.innerHTML = "";
        (s.tanks ?? []).forEach(t => els.tanksTbody.appendChild(tankRow(t.desc, t.mode, t.L, t.W, t.H, t.liters)));

        els.riversTbody.innerHTML = "";
        (s.rivers ?? []).forEach(r => els.riversTbody.appendChild(riverRow(r.desc, r.q_m3s, r.q_ls, r.hours)));

        // IMGW selections
        refreshIMGWDropdowns("woj");
        if (s.imgw?.woj) els.imgwWoj.value = s.imgw.woj;
        refreshIMGWDropdowns("woj");
        if (s.imgw?.pow) els.imgwPow.value = s.imgw.pow;
        refreshIMGWDropdowns("pow");
        if (s.imgw?.rzeka) els.imgwRzeka.value = s.imgw.rzeka;
        refreshIMGWDropdowns("rzeka");
        if (s.imgw?.stacja) els.imgwStacja.value = s.imgw.stacja;

        recalcLive();
        return true;
      } catch {
        return false;
      }
    }

    function resetAll() {
      localStorage.removeItem("kalkulator_wody_state_v4");
      location.reload();
    }

    // Defaults
    function initDefaultsIfNoState() {
      // vehicles
      els.vehiclesTbody.appendChild(vehicleRow("GBA 3,5/29", 3500));
      els.vehiclesTbody.appendChild(vehicleRow("GBA 2,5/16", 2500));
      els.vehiclesTbody.appendChild(vehicleRow("GCBA 5/32", 5000));

      // streams
      els.streamsTbody.appendChild(streamRow("Linia W-52 ~240 l/min", 240, 4));
      els.streamsTbody.appendChild(streamRow("Linia W-75 ~400 l/min", 400, 0));
      els.streamsTbody.appendChild(streamRow("Działko 2400", 2400, 3));
      els.streamsTbody.appendChild(streamRow("Działko 3200", 3200, 1));

      // hydrants
      els.hydrantsTbody.appendChild(hydrantRow("DN80", 0));
      els.hydrantsTbody.appendChild(hydrantRow("DN100", 0));

      // tanks
      els.tanksTbody.appendChild(tankRow("Zbiornik (wymiary)", "dims", 0, 0, 0, 0));

      // rivers
      els.riversTbody.appendChild(riverRow("Ciek (Q i czas)", 0, 0, 2));

      // IMGW dropdowns
      refreshIMGWDropdowns("woj");

      recalcLive();
    }

    // Events
    els.addVehicle.addEventListener("click", () => { els.vehiclesTbody.appendChild(vehicleRow("", 0)); recalcLive(); });
    els.addStream.addEventListener("click", () => { els.streamsTbody.appendChild(streamRow("", 0, 0)); recalcLive(); });
    els.addHydrant.addEventListener("click", () => { els.hydrantsTbody.appendChild(hydrantRow("DN80", 1)); recalcLive(); });
    els.addTank.addEventListener("click", () => { els.tanksTbody.appendChild(tankRow("", "dims", 0, 0, 0, 0)); recalcLive(); });
    els.addRiver.addEventListener("click", () => { els.riversTbody.appendChild(riverRow("", 0, 0, 2)); recalcLive(); });

    els.calc.addEventListener("click", compute);
    els.save.addEventListener("click", saveState);
    els.reset.addEventListener("click", resetAll);

    [els.A, els.qd, els.I].forEach(inp => inp.addEventListener("input", recalcLive));

    // IMGW events
    els.imgwWoj.addEventListener("input", () => { refreshIMGWDropdowns("woj"); });
    els.imgwPow.addEventListener("input", () => { refreshIMGWDropdowns("pow"); });
    els.imgwRzeka.addEventListener("input", () => { refreshIMGWDropdowns("rzeka"); });
    // stacja doesn't need cascade
    els.imgwAddToRivers.addEventListener("click", addSelectedStationToRivers);

    // Start
    if (!loadState()) initDefaultsIfNoState();
    setStatus("neutral", "GOTOWE", "Kliknij „Oblicz”. Możesz też zapisać ustawienia.");
  </script>
</body>
</html>
